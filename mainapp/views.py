from django.http import HttpRequest, HttpResponse
from django.shortcuts import render
from .predictor import malware_detector
from .models import Document
from .forms import DocumentForm
from pathlib import Path
import shutil

# Create your views here.

def index(request):
    form = DocumentForm()
    return render(request, 'home/index.html', {'form': form})

def check_malware_type(request):
    if (request.method == "POST"):
        d = Document.objects.create(title='hello world')
        d.document = request.FILES['document']
        d.save()
        file_name = str(request.FILES['document'])
        file_name_new = file_name.replace(" ", "_")
        base_loc = Path(__file__).resolve().parent.parent

        # form = DocumentForm(request.POST, request.FILES)
        # if form.is_valid():
        #     image = form.cleaned_data['document']
        #     save_doc = Document(document = image)
        #     save_doc.save()
        #     print(image)
        #     # form.save()
        file_location = str(base_loc) + '/media/detection_image/uploads/'+file_name_new
        new_data = malware_detector(file=file_location)
        main_type = new_data[0]
        sub_type = new_data[1]
        clear_file_dir = str(base_loc) + '/media/detection_image/uploads/'
        shutil.rmtree(clear_file_dir)
        return render(request, 'home/display.html', {'main_type': main_type, 'sub_type': sub_type})
    pass